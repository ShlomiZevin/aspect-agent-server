# Database Schema: zer4u - Retail Business Intelligence System

## Overview
This is a Hebrew-language retail business intelligence database containing sales, inventory, customer, and employee data. The schema supports comprehensive retail analytics including sales performance, inventory management, customer analysis, and operational metrics.

## ⚡ IMPORTANT: Use Materialized Views for Aggregations (FAST!)

### Sales by Store (`mv_sales_by_store`) - **USE THIS FOR STORE QUERIES**
Pre-aggregated sales totals by store. **ALWAYS use this instead of aggregating sales table for store-related questions.**

**Columns:**
- `store_number` (integer) - Store ID
- `store_name` (text) - Store name in Hebrew
- `transaction_count` (bigint) - Number of transactions
- `total_revenue` (numeric) - Total sales without VAT
- `avg_revenue` (numeric) - Average transaction value

**When to use:** Questions about "top stores", "sales by store", "store performance", "best stores", etc.

**Example queries:**
```sql
-- Top 5 stores by revenue
SELECT store_number, store_name, total_revenue
FROM zer4u.mv_sales_by_store
WHERE total_revenue IS NOT NULL
ORDER BY total_revenue DESC
LIMIT 5;

-- Specific store performance
SELECT * FROM zer4u.mv_sales_by_store WHERE store_number = 11;
```

### Sales by Customer (`mv_sales_by_customer`) - **USE THIS FOR CUSTOMER QUERIES**
Pre-aggregated purchases by customer. **ALWAYS use this for customer analysis.**

**Columns:**
- `customer_number` (integer) - Customer ID
- `customer_name` (text) - Customer name
- `purchase_count` (bigint) - Number of purchases
- `total_purchases` (numeric) - Total spending without VAT

**When to use:** Questions about "top customers", "customer spending", "best customers", etc.

**Example queries:**
```sql
-- Top 10 customers by spending
SELECT customer_number, customer_name, total_purchases
FROM zer4u.mv_sales_by_customer
WHERE total_purchases IS NOT NULL
ORDER BY total_purchases DESC
LIMIT 10;
```

### Sales by Product (`mv_sales_by_product`) - **USE THIS FOR PRODUCT QUERIES**
Pre-aggregated sales by product. **ALWAYS use this for product analysis.**

**Columns:**
- `item_code` (text) - Product code
- `item_name` (text) - Product name in Hebrew
- `total_quantity` (numeric) - Total units sold
- `total_revenue` (numeric) - Total revenue from this product

**When to use:** Questions about "top selling products", "best sellers", "popular items", etc.

**Example queries:**
```sql
-- Top 10 products by quantity sold
SELECT item_code, item_name, total_quantity
FROM zer4u.mv_sales_by_product
WHERE total_quantity IS NOT NULL
ORDER BY total_quantity DESC
LIMIT 10;

-- Top products by revenue
SELECT item_code, item_name, total_revenue
FROM zer4u.mv_sales_by_product
ORDER BY total_revenue DESC
LIMIT 10;
```

## Core Business Tables

### Sales Data (`sales` - 9.4M records)
**⚠️ WARNING: Direct aggregation on this table is VERY SLOW (2+ minutes). Use materialized views above for aggregated queries!**

Primary transaction table containing all sales activities:
- **Keys**: `UniqueInvoiceKey`, `InventoryKey`, `TargetKey`
- **Store Info**: `מס.חנות SALES` (store number - TEXT type), `CHNOT_ITSIRA` (store creation)
- **Dates**: `תאריך מקורי SALES` (original date - TEXT type)
- **Financial**: `מכירה ללא מע"מ` (sales without VAT - TEXT, needs ::numeric cast), `עלות ללא מע"מ` (cost without VAT)
- **Products**: `קוד פריט SALES` (item code - TEXT), `כמות ברמת שורה` (quantity - TEXT)
- **Customers**: `מס.לקוח` (customer number - TEXT type)

### Items/Products (`items` - 28K records)
Product catalog and pricing:
- **Identity**: `קוד פריט` (item code), `שם פריט` (item name)
- **Pricing**: Multiple price fields (`מחיר עלות 0/6`, `מחיר מחירון 1/2/4`)
- **Classification**: `קבוצת פריט` (item group), `תת קבוצת פריט` (sub-group)
- **Suppliers**: `שם ספק` (supplier name)

### Inventory (`inventory` - 19.8M records)
Stock levels and values:
- **Keys**: `InventoryKey`, `InventoryMahsanKey`
- **Metrics**: `יתרת מלאי` (stock balance), `ערך מלאי` (stock value)

### Customers (`customers` - 1.4M records)
Customer information:
- **Identity**: `מס.לקוח` (customer number - INTEGER type), `שם לקוח` (customer name)
- **Location**: `כתובת` (address), `ישוב` (settlement)
- **Demographics**: `מין` (gender)

### Stores (`stores` - 94 records)
Store master data:
- **Identity**: `מס.חנות` (store number - INTEGER type), `שם חנות` (store name)
- **Management**: `מנהל איזור` (area manager), `סוג חנות` (store type)
- **Lifecycle**: `תאריך פתיחת חנות` (opening date), `תאריך סגירת חנות` (closing date)

## Supporting Tables

### Calendar (`calendar` - 3.7K records)
Date dimension with Hebrew date fields:
- **Base**: `תאריך מקורי` (original date), `DateN` (date number)
- **Periods**: `שנה` (year), `חודש` (month), `רבעון` (quarter), `שבוע` (week)

### Employee Data
- **`employee_units_costed`**: Work hours and costs by employee and program
- **`units_delivery_costed`**: Delivery unit costs and employee assignments

### Financial Tables
- **`hesbonithiuvi`**: Invoice accounting records
- **`multips`**: Multi-purchase discounts
- **`shorot_kbla`**: Credit card payment details

## Key Relationships
- Sales ↔ Items: `קוד פריט SALES` (text) = `קוד פריט` (text)
- Sales ↔ Customers: `מס.לקוח` (text in sales, integer in customers) - REQUIRES CAST: `sales."מס.לקוח"::integer = customers."מס.לקוח"`
- Sales ↔ Stores: `מס.חנות SALES` (text) = `מס.חנות` (integer) - REQUIRES CAST: `sales."מס.חנות SALES"::integer = stores."מס.חנות"`
- Sales ↔ Calendar: `תאריך מקורי SALES` (text) = `תאריך מקורי` (text)
- Sales ↔ Inventory: via `InventoryKey` (text)
- Sales ↔ Targets: via `TargetKey` (text)

## Important Notes
1. **Language**: Most column names are in Hebrew; some are mixed Hebrew/English
2. **Text Types**: Many numeric values stored as text fields - MUST cast with ::numeric or ::integer
3. **Keys**: Complex composite keys used for linking (`UniqueInvoiceKey`, `InventoryKey`, etc.)
4. **Dates**: Stored as text, various date dimension tables for analysis
5. **Nullability**: All columns allow NULL values
6. **Mixed Data**: Some tables contain both transactional and dimensional data
7. **Type Mismatches**: CRITICAL - Use INDEXED helper functions for sales table joins/filters:
   - Store numbers: `zer4u.to_int_safe(s."מס.חנות SALES") = st."מס.חנות"` (uses idx_sales_store_date - FAST!)
   - Customer numbers: `zer4u.to_int_safe(s."מס.לקוח") = c."מס.לקוח"` (uses idx_sales_customer_date - FAST!)
   - NEVER use `::integer` cast directly on these - skips the index and is SLOW
   - Numeric values: stored as text - MUST cast: `"מכירה ללא מע""מ"::numeric`
8. **Date Filtering**: CRITICAL - Use the INDEXED parse function:
   - `zer4u.parse_date_ddmmyyyy(s."תאריך מקורי SALES") >= 'YYYY-MM-DD'::date` (uses idx_sales_date_parsed - FAST!)
   - NEVER use `TO_DATE(column, 'DD/MM/YYYY')` in WHERE clauses - skips index and is SLOW
   - NEVER use `::date` cast - fails with "date/time field value out of range"
9. **Performance**:
   - ✅ USE materialized views for aggregations (instant results)
   - ✅ USE `zer4u.parse_date_ddmmyyyy()` for date filters (uses expression index)
   - ✅ USE `zer4u.to_int_safe()` for store/customer joins (uses expression index)
   - ❌ AVOID direct aggregation on full sales table without date filter (very slow)
   - ❌ AVOID `TO_DATE()` or `::integer` casts on indexed columns (skips index)

## Query Strategy
1. **For aggregated data** (top X, totals, summaries): Use materialized views
2. **For time-filtered data** (this month, last week, trends): Use sales table with `zer4u.parse_date_ddmmyyyy()` filter
3. **For JOINs**: Use `zer4u.to_int_safe()` for store/customer, `::numeric` for amounts
4. **For column names with quotes**: Escape by doubling: `"מכירה ללא מע""מ"` (note the doubled quote)

## Common Analysis Patterns
- **Top stores by revenue**: `SELECT * FROM zer4u.mv_sales_by_store ORDER BY total_revenue DESC LIMIT 10`
- **Top customers**: `SELECT * FROM zer4u.mv_sales_by_customer ORDER BY total_purchases DESC LIMIT 10`
- **Best selling products**: `SELECT * FROM zer4u.mv_sales_by_product ORDER BY total_quantity DESC LIMIT 10`
- **Store performance**: `SELECT * FROM zer4u.mv_sales_by_store WHERE store_number = X`
- **Sales this month**: `SELECT SUM("מכירה ללא מע""מ"::numeric) FROM zer4u.sales WHERE zer4u.parse_date_ddmmyyyy("תאריך מקורי SALES") >= date_trunc('month', CURRENT_DATE)`
- **Sales last 30 days**: `SELECT SUM("מכירה ללא מע""מ"::numeric) FROM zer4u.sales WHERE zer4u.parse_date_ddmmyyyy("תאריך מקורי SALES") >= CURRENT_DATE - INTERVAL '30 days'`
- **Customer history**: Join sales with customers using proper CAST
